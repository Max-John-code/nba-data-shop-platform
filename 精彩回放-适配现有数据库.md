# 精彩回放功能 - 适配现有数据库

## 说明
此版本适配你现有的 highlight 表结构（使用 video_url 和 cover_image 字段存储文件路径）。

## 现有表结构
```sql
CREATE TABLE `highlight` (
  `id` bigint NOT NULL AUTO_INCREMENT,
  `title` varchar(200) NOT NULL,
  `description` text NOT NULL,
  `video_url` varchar(500) NOT NULL,      -- 存储视频文件路径
  `cover_image` varchar(500) DEFAULT '',  -- 存储封面图片路径
  `match_date` date NOT NULL,
  `teams` varchar(100) NOT NULL,
  `views` int NOT NULL DEFAULT '0',
  `duration` int NOT NULL DEFAULT '0',
  `created_at` datetime(6) NOT NULL,
  `updated_at` datetime(6) NOT NULL,
  `is_active` tinyint(1) NOT NULL DEFAULT '1',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## 快速启动步骤

### 1. 创建媒体目录

```bash
cd nba_backend

# Windows
mkdir media\highlights\videos
mkdir media\highlights\covers

# Linux/Mac
mkdir -p media/highlights/videos
mkdir -p media/highlights/covers
```

### 2. 标记数据库迁移为已完成

```bash
# 激活虚拟环境
conda activate nba_env

cd nba_backend

# 删除旧的迁移文件（如果存在）
del highlights\migrations\0001_initial.py

# 重新生成迁移
python manage.py makemigrations highlights

# 标记为已完成（表已存在）
python manage.py migrate highlights --fake
```

### 3. 启动后端服务

```bash
python manage.py runserver
```

### 4. 启动前端服务

```bash
cd nba-data-shop-platform
npm run dev:h5
```

## 使用说明

### 管理员上传视频

1. 登录管理员账号
2. 进入"管理后台" → "精彩回放管理"
3. 点击"添加回放"
4. 填写表单：
   - 标题
   - 对阵球队
   - 比赛日期
   - 点击"选择视频"上传视频文件
   - 点击"选择图片"上传封面（可选）
   - 填写描述
5. 提交

### 文件存储说明

- 视频文件会保存到：`nba_backend/media/highlights/videos/`
- 封面图片会保存到：`nba_backend/media/highlights/covers/`
- 数据库中存储的是相对路径，例如：`highlights/videos/video1.mp4`
- 访问URL会自动拼接为：`http://127.0.0.1:8000/media/highlights/videos/video1.mp4`

### 用户观看视频

1. 首页导航栏点击"精彩回放"
2. 浏览视频列表
3. 点击视频卡片播放
4. 观看次数自动统计

## API 接口

### 获取列表
```
GET /api/highlights/
返回字段包括：
- video_full_url: 视频的完整访问URL
- cover_full_url: 封面的完整访问URL
```

### 上传视频（管理员）
```
POST /api/highlights/
Content-Type: multipart/form-data

参数：
- title: 标题
- teams: 对阵球队
- match_date: 比赛日期
- video: 视频文件
- cover_image: 封面图片（可选）
- duration: 时长（秒）
- description: 描述
- is_active: 是否启用
```

## 测试建议

1. 准备一些短视频文件（10-30秒，MP4格式）
2. 准备对应的封面图片（JPG/PNG格式）
3. 通过管理后台上传测试
4. 在用户端查看和播放

## 常见问题

### Q: 表已存在错误？
A: 使用 `python manage.py migrate highlights --fake` 标记迁移为已完成

### Q: 视频上传失败？
A: 检查：
- media 目录是否已创建
- 文件大小是否超过100MB
- 后端服务是否正常运行

### Q: 视频无法播放？
A: 检查：
- 视频格式是否为浏览器支持的格式（推荐MP4）
- MEDIA_URL 配置是否正确
- 文件路径是否正确

### Q: 封面不显示？
A: 检查：
- 图片文件是否上传成功
- 图片路径是否正确
- 浏览器控制台是否有错误

## 目录结构

```
nba_backend/
├── media/                    # 媒体文件根目录
│   └── highlights/
│       ├── videos/          # 视频文件
│       │   ├── video1.mp4
│       │   └── video2.mp4
│       └── covers/          # 封面图片
│           ├── cover1.jpg
│           └── cover2.jpg
├── highlights/              # 应用目录
│   ├── models.py           # 使用 video_url 字段
│   ├── views.py            # 处理文件上传
│   └── serializers.py      # 返回完整URL
└── manage.py
```

## 数据示例

数据库中存储：
```json
{
  "video_url": "highlights/videos/lebron_dunk.mp4",
  "cover_image": "highlights/covers/lebron_cover.jpg"
}
```

API 返回：
```json
{
  "video_url": "highlights/videos/lebron_dunk.mp4",
  "cover_image": "highlights/covers/lebron_cover.jpg",
  "video_full_url": "http://127.0.0.1:8000/media/highlights/videos/lebron_dunk.mp4",
  "cover_full_url": "http://127.0.0.1:8000/media/highlights/covers/lebron_cover.jpg"
}
```
